(function(F,Q){typeof exports=="object"&&typeof module!="undefined"?module.exports=Q():typeof define=="function"&&define.amd?define(Q):(F=typeof globalThis!="undefined"?globalThis:F||self,F.StaticImageSource=Q())})(this,function(){"use strict";function F(t){for(var r=x(),n=0,e=t.length;n<e;++n)tt(r,t[n]);return r}function Q(t,r,n){var e=Math.min.apply(null,t),i=Math.min.apply(null,r),a=Math.max.apply(null,t),o=Math.max.apply(null,r);return dt(e,i,a,o,n)}function St(t,r){return Ut(t,r[0],r[1])}function Ut(t,r,n){return t[0]<=r&&r<=t[2]&&t[1]<=n&&n<=t[3]}function x(){return[1/0,1/0,-1/0,-1/0]}function dt(t,r,n,e,i){return i?(i[0]=t,i[1]=r,i[2]=n,i[3]=e,i):[t,r,n,e]}function Xt(t){return dt(1/0,1/0,-1/0,-1/0,t)}function jt(t,r){return r[0]<t[0]&&(t[0]=r[0]),r[2]>t[2]&&(t[2]=r[2]),r[1]<t[1]&&(t[1]=r[1]),r[3]>t[3]&&(t[3]=r[3]),t}function tt(t,r){r[0]<t[0]&&(t[0]=r[0]),r[0]>t[2]&&(t[2]=r[0]),r[1]<t[1]&&(t[1]=r[1]),r[1]>t[3]&&(t[3]=r[1])}function Nt(t){var r=0;return Qt(t)||(r=P(t)*S(t)),r}function $t(t){return[t[0],t[1]]}function Bt(t){return[t[2],t[1]]}function Ht(t){return[(t[0]+t[2])/2,(t[1]+t[3])/2]}function S(t){return t[3]-t[1]}function Yt(t,r,n){var e=n||x();return _t(t,r)?(t[0]>r[0]?e[0]=t[0]:e[0]=r[0],t[1]>r[1]?e[1]=t[1]:e[1]=r[1],t[2]<r[2]?e[2]=t[2]:e[2]=r[2],t[3]<r[3]?e[3]=t[3]:e[3]=r[3]):Xt(e),e}function gt(t){return[t[0],t[3]]}function kt(t){return[t[2],t[3]]}function P(t){return t[2]-t[0]}function _t(t,r){return t[0]<=r[2]&&t[2]>=r[0]&&t[1]<=r[3]&&t[3]>=r[1]}function Qt(t){return t[2]<t[0]||t[3]<t[1]}function qt(t,r,n,e){var i=[];if(e>1)for(var a=t[2]-t[0],o=t[3]-t[1],s=0;s<e;++s)i.push(t[0]+a*s/e,t[1],t[2],t[1]+o*s/e,t[2]-a*s/e,t[3],t[0],t[3]-o*s/e);else i=[t[0],t[1],t[2],t[1],t[2],t[3],t[0],t[3]];r(i,i,2);for(var h=[],l=[],s=0,c=i.length;s<c;s+=2)h.push(i[s]),l.push(i[s+1]);return Q(h,l,n)}var U={RADIANS:"radians",DEGREES:"degrees",FEET:"ft",METERS:"m",PIXELS:"pixels",TILE_PIXELS:"tile-pixels",USFEET:"us-ft"},M={};M[U.RADIANS]=6370997/(2*Math.PI),M[U.DEGREES]=2*Math.PI*6370997/360,M[U.FEET]=.3048,M[U.METERS]=1,M[U.USFEET]=1200/3937;var q=U,Kt=function(){function t(r){this.code_=r.code,this.units_=r.units,this.extent_=r.extent!==void 0?r.extent:null,this.worldExtent_=r.worldExtent!==void 0?r.worldExtent:null,this.axisOrientation_=r.axisOrientation!==void 0?r.axisOrientation:"enu",this.global_=r.global!==void 0?r.global:!1,this.canWrapX_=!!(this.global_&&this.extent_),this.getPointResolutionFunc_=r.getPointResolution,this.defaultTileGrid_=null,this.metersPerUnit_=r.metersPerUnit}return t.prototype.canWrapX=function(){return this.canWrapX_},t.prototype.getCode=function(){return this.code_},t.prototype.getExtent=function(){return this.extent_},t.prototype.getUnits=function(){return this.units_},t.prototype.getMetersPerUnit=function(){return this.metersPerUnit_||M[this.units_]},t.prototype.getWorldExtent=function(){return this.worldExtent_},t.prototype.getAxisOrientation=function(){return this.axisOrientation_},t.prototype.isGlobal=function(){return this.global_},t.prototype.setGlobal=function(r){this.global_=r,this.canWrapX_=!!(r&&this.extent_)},t.prototype.getDefaultTileGrid=function(){return this.defaultTileGrid_},t.prototype.setDefaultTileGrid=function(r){this.defaultTileGrid_=r},t.prototype.setExtent=function(r){this.extent_=r,this.canWrapX_=!!(this.global_&&r)},t.prototype.setWorldExtent=function(r){this.worldExtent_=r},t.prototype.setGetPointResolution=function(r){this.getPointResolutionFunc_=r},t.prototype.getPointResolutionFunc=function(){return this.getPointResolutionFunc_},t}(),Et=Kt,Vt=function(){var t;return"cosh"in Math?t=Math.cosh:t=function(r){var n=Math.exp(r);return(n+1/n)/2},t}(),bt=function(){var t;return"log2"in Math?t=Math.log2:t=function(r){return Math.log(r)*Math.LOG2E},t}();function Jt(t){for(var r=t.length,n=0;n<r;n++){for(var e=n,i=Math.abs(t[n][n]),a=n+1;a<r;a++){var o=Math.abs(t[a][n]);o>i&&(i=o,e=a)}if(i===0)return null;var s=t[e];t[e]=t[n],t[n]=s;for(var h=n+1;h<r;h++)for(var l=-t[h][n]/t[n][n],c=n;c<r+1;c++)n==c?t[h][c]=0:t[h][c]+=l*t[n][c]}for(var g=new Array(r),f=r-1;f>=0;f--){g[f]=t[f][r]/t[f][f];for(var d=f-1;d>=0;d--)t[d][r]-=t[d][f]*g[f]}return g}function et(t){return t*Math.PI/180}function it(t,r){var n=t%r;return n*r<0?n+r:n}var Zt=function(){var t=function(r,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])},t(r,n)};return function(r,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");t(r,n);function e(){this.constructor=r}r.prototype=n===null?Object.create(n):(e.prototype=n.prototype,new e)}}(),K=6378137,X=Math.PI*K,zt=[-X,-X,X,X],xt=[-180,-85,180,85],rt=K*Math.log(Math.tan(Math.PI/2)),j=function(t){Zt(r,t);function r(n){return t.call(this,{code:n,units:q.METERS,extent:zt,global:!0,worldExtent:xt,getPointResolution:function(e,i){return e/Vt(i[1]/K)}})||this}return r}(Et),pt=[new j("EPSG:3857"),new j("EPSG:102100"),new j("EPSG:102113"),new j("EPSG:900913"),new j("http://www.opengis.net/def/crs/EPSG/0/3857"),new j("http://www.opengis.net/gml/srs/epsg.xml#3857")];function tr(t,r,n){var e=t.length,i=n>1?n:2,a=r;a===void 0&&(i>2?a=t.slice():a=new Array(e));for(var o=0;o<e;o+=i){a[o]=X*t[o]/180;var s=K*Math.log(Math.tan(Math.PI*(+t[o+1]+90)/360));s>rt?s=rt:s<-rt&&(s=-rt),a[o+1]=s}return a}function rr(t,r,n){var e=t.length,i=n>1?n:2,a=r;a===void 0&&(i>2?a=t.slice():a=new Array(e));for(var o=0;o<e;o+=i)a[o]=180*t[o]/X,a[o+1]=360*Math.atan(Math.exp(t[o+1]/K))/Math.PI-90;return a}var nr=function(){var t=function(r,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])},t(r,n)};return function(r,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");t(r,n);function e(){this.constructor=r}r.prototype=n===null?Object.create(n):(e.prototype=n.prototype,new e)}}(),er=6378137,mt=[-180,-90,180,90],ir=Math.PI*er/180,G=function(t){nr(r,t);function r(n,e){return t.call(this,{code:n,units:q.DEGREES,extent:mt,axisOrientation:e,global:!0,metersPerUnit:ir,worldExtent:mt})||this}return r}(Et),yt=[new G("CRS:84"),new G("EPSG:4326","neu"),new G("urn:ogc:def:crs:OGC:1.3:CRS84"),new G("urn:ogc:def:crs:OGC:2:84"),new G("http://www.opengis.net/def/crs/OGC/1.3/CRS84","neu"),new G("http://www.opengis.net/gml/srs/epsg.xml#4326","neu"),new G("http://www.opengis.net/def/crs/EPSG/0/4326","neu")],at={};function ar(t){return at[t]||at[t.replace(/urn:(x-)?ogc:def:crs:EPSG:(.*:)?(\w+)$/,"EPSG:$3")]||null}function or(t,r){at[t]=r}var Pt=typeof Object.assign=="function"?Object.assign:function(t,r){if(t==null)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(t),e=1,i=arguments.length;e<i;++e){var a=arguments[e];if(a!=null)for(var o in a)a.hasOwnProperty(o)&&(n[o]=a[o])}return n};function sr(t){for(var r in t)delete t[r]}var N={};function nt(t,r,n){var e=t.getCode(),i=r.getCode();e in N||(N[e]={}),N[e][i]=n}function fr(t,r){var n;return t in N&&r in N[t]&&(n=N[t][r]),n}var ur=63710088e-1;function It(t,r,n){var e=n||ur,i=et(t[1]),a=et(r[1]),o=(a-i)/2,s=et(r[0]-t[0])/2,h=Math.sin(o)*Math.sin(o)+Math.sin(s)*Math.sin(s)*Math.cos(i)*Math.cos(a);return 2*e*Math.atan2(Math.sqrt(h),Math.sqrt(1-h))}function Ot(t,r,n){var e;if(r!==void 0){for(var i=0,a=t.length;i<a;++i)r[i]=t[i];e=r}else e=t.slice();return e}function Tt(t,r,n){if(r!==void 0&&t!==r){for(var e=0,i=t.length;e<i;++e)r[e]=t[e];t=r}return t}function hr(t){or(t.getCode(),t),nt(t,t,Ot)}function lr(t){t.forEach(hr)}function $(t){return typeof t=="string"?ar(t):t||null}function Mt(t,r,n,e){t=$(t);var i,a=t.getPointResolutionFunc();if(a){if(i=a(r,n),e&&e!==t.getUnits()){var o=t.getMetersPerUnit();o&&(i=i*o/M[e])}}else{var s=t.getUnits();if(s==q.DEGREES&&!e||e==q.DEGREES)i=r;else{var h=Rt(t,$("EPSG:4326"));if(h===Tt&&s!==q.DEGREES)i=r*t.getMetersPerUnit();else{var l=[n[0]-r/2,n[1],n[0]+r/2,n[1],n[0],n[1]-r/2,n[0],n[1]+r/2];l=h(l,l,2);var c=It(l.slice(0,2),l.slice(2,4)),g=It(l.slice(4,6),l.slice(6,8));i=(c+g)/2}var o=e?M[e]:t.getMetersPerUnit();o!==void 0&&(i/=o)}}return i}function wt(t){lr(t),t.forEach(function(r){t.forEach(function(n){r!==n&&nt(r,n,Ot)})})}function vr(t,r,n,e){t.forEach(function(i){r.forEach(function(a){nt(i,a,n),nt(a,i,e)})})}function Rt(t,r){var n=t.getCode(),e=r.getCode(),i=fr(n,e);return i||(i=Tt),i}function ot(t,r){var n=$(t),e=$(r);return Rt(n,e)}function cr(t,r,n){var e=ot(r,n);return e(t,void 0,t.length)}function Dt(t,r,n,e){var i=ot(r,n);return qt(t,i,void 0,e)}function dr(){wt(pt),wt(yt),vr(yt,pt,tr,rr)}dr();var gr={imageSmoothingEnabled:!1,msImageSmoothingEnabled:!1},B=typeof navigator!="undefined"&&typeof navigator.userAgent!="undefined"?navigator.userAgent.toLowerCase():"";B.indexOf("firefox"),B.indexOf("safari")!==-1&&B.indexOf("chrom")==-1,B.indexOf("webkit")!==-1&&B.indexOf("edge")==-1,B.indexOf("macintosh");var _r=typeof WorkerGlobalScope!="undefined"&&typeof OffscreenCanvas!="undefined"&&self instanceof WorkerGlobalScope;(function(){var t=!1;try{var r=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("_",null,r),window.removeEventListener("_",null,r)}catch{}return t})();function Wt(t,r,n,e){var i;return n&&n.length?i=n.shift():_r?i=new OffscreenCanvas(t||300,r||300):(i=document.createElement("canvas"),i.style.all="unset"),t&&(i.width=t),r&&(i.height=r),i.getContext("2d",e)}var st;function Ct(t,r,n,e,i){t.beginPath(),t.moveTo(0,0),t.lineTo(r,n),t.lineTo(e,i),t.closePath(),t.save(),t.clip(),t.fillRect(0,0,Math.max(r,e)+1,Math.max(n,i)),t.restore()}function ft(t,r){return Math.abs(t[r*4]-210)>2||Math.abs(t[r*4+3]-.75*255)>2}function Er(){if(st===void 0){var t=document.createElement("canvas").getContext("2d");t.globalCompositeOperation="lighter",t.fillStyle="rgba(210, 0, 0, 0.75)",Ct(t,4,5,4,0),Ct(t,4,5,0,5);var r=t.getImageData(0,0,3,3).data;st=ft(r,0)||ft(r,4)||ft(r,8)}return st}function pr(t,r,n,e){var i=cr(n,r,t),a=Mt(r,e,n),o=r.getMetersPerUnit();o!==void 0&&(a*=o);var s=t.getMetersPerUnit();s!==void 0&&(a/=s);var h=t.getExtent();if(!h||St(h,i)){var l=Mt(t,a,i)/a;isFinite(l)&&l>0&&(a/=l)}return a}function mr(t,r,n,e,i,a,o,s,h,l,c,g){var f=Wt(Math.round(n*t),Math.round(n*r));if(Pt(f,g),h.length===0)return f.canvas;f.scale(n,n);function d(u){return Math.round(u*n)/n}f.globalCompositeOperation="lighter";var _=x();h.forEach(function(u,w,R){jt(_,u.extent)});var b=P(_),J=S(_),p=Wt(Math.round(n*b/e),Math.round(n*J/e));Pt(p,g);var y=n/e;h.forEach(function(u,w,R){var E=u.extent[0]-_[0],m=-(u.extent[3]-_[3]),O=P(u.extent),I=S(u.extent);u.image.width>0&&u.image.height>0&&p.drawImage(u.image,l,l,u.image.width-2*l,u.image.height-2*l,E*y,m*y,O*y,I*y)});var v=gt(o);return s.getTriangles().forEach(function(u,w,R){var E=u.source,m=u.target,O=E[0][0],I=E[0][1],D=E[1][0],T=E[1][1],W=E[2][0],L=E[2][1],C=d((m[0][0]-v[0])/a),Z=d(-(m[0][1]-v[1])/a),H=d((m[1][0]-v[0])/a),Y=d(-(m[1][1]-v[1])/a),ht=d((m[2][0]-v[0])/a),lt=d(-(m[2][1]-v[1])/a),vt=O,ct=I;O=0,I=0,D-=vt,T-=ct,W-=vt,L-=ct;var Ar=[[D,T,0,0,H-C],[W,L,0,0,ht-C],[0,0,D,T,Y-Z],[0,0,W,L,lt-Z]],z=Jt(Ar);if(!!z){if(f.save(),f.beginPath(),Er()||g===gr){f.moveTo(H,Y);for(var k=4,At=C-H,Ft=Z-Y,A=0;A<k;A++)f.lineTo(H+d((A+1)*At/k),Y+d(A*Ft/(k-1))),A!=k-1&&f.lineTo(H+d((A+1)*At/k),Y+d((A+1)*Ft/(k-1)));f.lineTo(ht,lt)}else f.moveTo(H,Y),f.lineTo(C,Z),f.lineTo(ht,lt);f.clip(),f.transform(z[0],z[2],z[1],z[3],C,Z),f.translate(_[0]-vt,_[3]-ct),f.scale(e/n,-e/n),f.drawImage(p.canvas,0,0),f.restore()}}),c&&(f.save(),f.globalCompositeOperation="source-over",f.strokeStyle="black",f.lineWidth=1,s.getTriangles().forEach(function(u,w,R){var E=u.target,m=(E[0][0]-v[0])/a,O=-(E[0][1]-v[1])/a,I=(E[1][0]-v[0])/a,D=-(E[1][1]-v[1])/a,T=(E[2][0]-v[0])/a,W=-(E[2][1]-v[1])/a;f.beginPath(),f.moveTo(I,D),f.lineTo(m,O),f.lineTo(T,W),f.closePath(),f.stroke()}),f.restore()),f.canvas}var yr=.5,Pr=10,Gt=.25,Ir=function(){function t(r,n,e,i,a,o){this.sourceProj_=r,this.targetProj_=n;var s={},h=ot(this.targetProj_,this.sourceProj_);this.transformInv_=function(v){var u=v[0]+"/"+v[1];return s[u]||(s[u]=h(v)),s[u]},this.maxSourceExtent_=i,this.errorThresholdSquared_=a*a,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!i&&!!this.sourceProj_.getExtent()&&P(i)==P(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?P(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?P(this.targetProj_.getExtent()):null;var l=gt(e),c=kt(e),g=Bt(e),f=$t(e),d=this.transformInv_(l),_=this.transformInv_(c),b=this.transformInv_(g),J=this.transformInv_(f),p=Pr+(o?Math.max(0,Math.ceil(bt(Nt(e)/(o*o*256*256)))):0);if(this.addQuad_(l,c,g,f,d,_,b,J,p),this.wrapsXInSource_){var y=1/0;this.triangles_.forEach(function(v,u,w){y=Math.min(y,v.source[0][0],v.source[1][0],v.source[2][0])}),this.triangles_.forEach(function(v){if(Math.max(v.source[0][0],v.source[1][0],v.source[2][0])-y>this.sourceWorldWidth_/2){var u=[[v.source[0][0],v.source[0][1]],[v.source[1][0],v.source[1][1]],[v.source[2][0],v.source[2][1]]];u[0][0]-y>this.sourceWorldWidth_/2&&(u[0][0]-=this.sourceWorldWidth_),u[1][0]-y>this.sourceWorldWidth_/2&&(u[1][0]-=this.sourceWorldWidth_),u[2][0]-y>this.sourceWorldWidth_/2&&(u[2][0]-=this.sourceWorldWidth_);var w=Math.min(u[0][0],u[1][0],u[2][0]),R=Math.max(u[0][0],u[1][0],u[2][0]);R-w<this.sourceWorldWidth_/2&&(v.source=u)}}.bind(this))}s={}}return t.prototype.addTriangle_=function(r,n,e,i,a,o){this.triangles_.push({source:[i,a,o],target:[r,n,e]})},t.prototype.addQuad_=function(r,n,e,i,a,o,s,h,l){var c=F([a,o,s,h]),g=this.sourceWorldWidth_?P(c)/this.sourceWorldWidth_:null,f=this.sourceWorldWidth_,d=this.sourceProj_.canWrapX()&&g>.5&&g<1,_=!1;if(l>0){if(this.targetProj_.isGlobal()&&this.targetWorldWidth_){var b=F([r,n,e,i]),J=P(b)/this.targetWorldWidth_;_=J>Gt||_}!d&&this.sourceProj_.isGlobal()&&g&&(_=g>Gt||_)}if(!(!_&&this.maxSourceExtent_&&isFinite(c[0])&&isFinite(c[1])&&isFinite(c[2])&&isFinite(c[3])&&!_t(c,this.maxSourceExtent_))){var p=0;if(!_&&(!isFinite(a[0])||!isFinite(a[1])||!isFinite(o[0])||!isFinite(o[1])||!isFinite(s[0])||!isFinite(s[1])||!isFinite(h[0])||!isFinite(h[1]))){if(l>0)_=!0;else if(p=(!isFinite(a[0])||!isFinite(a[1])?8:0)+(!isFinite(o[0])||!isFinite(o[1])?4:0)+(!isFinite(s[0])||!isFinite(s[1])?2:0)+(!isFinite(h[0])||!isFinite(h[1])?1:0),p!=1&&p!=2&&p!=4&&p!=8)return}if(l>0){if(!_){var y=[(r[0]+e[0])/2,(r[1]+e[1])/2],v=this.transformInv_(y),u=void 0;if(d){var w=(it(a[0],f)+it(s[0],f))/2;u=w-it(v[0],f)}else u=(a[0]+s[0])/2-v[0];var R=(a[1]+s[1])/2-v[1],E=u*u+R*R;_=E>this.errorThresholdSquared_}if(_){if(Math.abs(r[0]-e[0])<=Math.abs(r[1]-e[1])){var m=[(n[0]+e[0])/2,(n[1]+e[1])/2],O=this.transformInv_(m),I=[(i[0]+r[0])/2,(i[1]+r[1])/2],D=this.transformInv_(I);this.addQuad_(r,n,m,I,a,o,O,D,l-1),this.addQuad_(I,m,e,i,D,O,s,h,l-1)}else{var T=[(r[0]+n[0])/2,(r[1]+n[1])/2],W=this.transformInv_(T),L=[(e[0]+i[0])/2,(e[1]+i[1])/2],C=this.transformInv_(L);this.addQuad_(r,T,L,i,a,W,C,h,l-1),this.addQuad_(T,n,e,L,W,o,s,C,l-1)}return}}if(d){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}(p&11)==0&&this.addTriangle_(r,e,i,a,s,h),(p&14)==0&&this.addTriangle_(r,e,n,a,s,o),p&&((p&13)==0&&this.addTriangle_(n,i,r,o,h,a),(p&7)==0&&this.addTriangle_(n,i,e,o,h,s))}},t.prototype.calculateSourceExtent=function(){var r=x();return this.triangles_.forEach(function(n,e,i){var a=n.source;tt(r,a[0]),tt(r,a[1]),tt(r,a[2])}),r},t.prototype.getTriangles=function(){return this.triangles_},t}(),Or=Ir,Tr=function(){function t(){this.disposed=!1}return t.prototype.dispose=function(){this.disposed||(this.disposed=!0,this.disposeInternal())},t.prototype.disposeInternal=function(){},t}(),Mr=Tr,wr=function(){function t(r){this.propagationStopped,this.defaultPrevented,this.type=r,this.target=null}return t.prototype.preventDefault=function(){this.defaultPrevented=!0},t.prototype.stopPropagation=function(){this.propagationStopped=!0},t}(),Rr=wr;function Lt(){}var Dr=function(){var t=function(r,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])},t(r,n)};return function(r,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");t(r,n);function e(){this.constructor=r}r.prototype=n===null?Object.create(n):(e.prototype=n.prototype,new e)}}(),Wr=function(t){Dr(r,t);function r(n){var e=t.call(this)||this;return e.eventTarget_=n,e.pendingRemovals_=null,e.dispatching_=null,e.listeners_=null,e}return r.prototype.addEventListener=function(n,e){if(!(!n||!e)){var i=this.listeners_||(this.listeners_={}),a=i[n]||(i[n]=[]);a.indexOf(e)===-1&&a.push(e)}},r.prototype.dispatchEvent=function(n){var e=typeof n=="string"?new Rr(n):n,i=e.type;e.target||(e.target=this.eventTarget_||this);var a=this.listeners_&&this.listeners_[i],o;if(a){var s=this.dispatching_||(this.dispatching_={}),h=this.pendingRemovals_||(this.pendingRemovals_={});i in s||(s[i]=0,h[i]=0),++s[i];for(var l=0,c=a.length;l<c;++l)if("handleEvent"in a[l]?o=a[l].handleEvent(e):o=a[l].call(this,e),o===!1||e.propagationStopped){o=!1;break}if(--s[i],s[i]===0){var g=h[i];for(delete h[i];g--;)this.removeEventListener(i,Lt);delete s[i]}return o}},r.prototype.disposeInternal=function(){this.listeners_&&sr(this.listeners_)},r.prototype.getListeners=function(n){return this.listeners_&&this.listeners_[n]||void 0},r.prototype.hasListener=function(n){return this.listeners_?n?n in this.listeners_:Object.keys(this.listeners_).length>0:!1},r.prototype.removeEventListener=function(n,e){var i=this.listeners_&&this.listeners_[n];if(i){var a=i.indexOf(e);a!==-1&&(this.pendingRemovals_&&n in this.pendingRemovals_?(i[a]=Lt,++this.pendingRemovals_[n]):(i.splice(a,1),i.length===0&&delete this.listeners_[n]))}},r}(Mr),Cr=Wr,Gr={CHANGE:"change",ERROR:"error",BLUR:"blur",CLEAR:"clear",CONTEXTMENU:"contextmenu",CLICK:"click",DBLCLICK:"dblclick",DRAGENTER:"dragenter",DRAGOVER:"dragover",DROP:"drop",FOCUS:"focus",KEYDOWN:"keydown",KEYPRESS:"keypress",LOAD:"load",RESIZE:"resize",TOUCHMOVE:"touchmove",WHEEL:"wheel"},ut;(function(t){t[t.IDLE=0]="IDLE",t[t.LOADING=1]="LOADING",t[t.LOADED=2]="LOADED",t[t.ERROR=3]="ERROR",t[t.EMPTY=4]="EMPTY"})(ut||(ut={}));var V=ut;class Lr extends Cr{constructor(r){super();this.type="canvas",this._options=r,this._projection=$(r.projection),this._imageExtent=r.imageExtent,this._initCoordinates(),this._loadImage()}_initCoordinates(){const{projection:r,imageExtent:n}=this._options,e=Dt(n,r,"EPSG:4326");this.coordinates=[[e[0],e[3]],[e[2],e[3]],[e[2],e[1]],[e[0],e[1]]]}_loadImage(){const{crossOrigin:r,url:n}=this._options,e=new Image;r&&(e.crossOrigin=r),e.src=n,e.src&&typeof Image!="undefined"&&Image.prototype.decode&&e.decode().then(()=>this._handleImageLoad()).catch(a=>{console.error(a),this._handleImageError()}),this._imageState=V.IDLE,this._image=e}_handleImageLoad(){this.getResolution()===void 0&&(this._resolution=S(this._options.imageExtent)/this._image.height),this._imageState=V.LOADED,this._handleImageChange()}_handleImageError(){this._imageState=V.ERROR}_handleImageChange(){this.getImageState()==V.LOADED&&this._reprojectImage()}_reprojectImage(){const r=this.getProjection(),n=$("EPSG:3857"),e=Dt(this._imageExtent,r,n),i=P(e)/this._image.width,a=S(e)/this._image.height,o=Math.max(i,a);this._reproject(r,n,e,o)}_reproject(r,n,e,i){if(this.getImageState()==V.LOADED){const a=r.getExtent(),o=n.getExtent(),s=P(e)/i,h=S(e)/i,l=1,c=o?Yt(e,o):e,g=Ht(c),f=pr(r,n,g,i),d=new Or(r,n,c,a,f*yr,i);this.canvas=mr(s,h,l,this.getResolution(),a,i,e,d,[{extent:this._options.imageExtent,image:this._image}],0),this.dispatchEvent(Gr.LOAD)}}getProjection(){return this._projection}getImageState(){return this._imageState}getResolution(){return this._resolution}}return Lr});
