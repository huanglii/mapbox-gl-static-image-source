(function(F,q){typeof exports=="object"&&typeof module!="undefined"?module.exports=q():typeof define=="function"&&define.amd?define(q):(F=typeof globalThis!="undefined"?globalThis:F||self,F.StaticImageSource=q())})(this,function(){"use strict";function F(t){for(var r=x(),e=0,n=t.length;e<n;++e)tt(r,t[e]);return r}function q(t,r,e){var n=Math.min.apply(null,t),i=Math.min.apply(null,r),a=Math.max.apply(null,t),o=Math.max.apply(null,r);return dt(n,i,a,o,e)}function St(t,r){return Ut(t,r[0],r[1])}function Ut(t,r,e){return t[0]<=r&&r<=t[2]&&t[1]<=e&&e<=t[3]}function x(){return[1/0,1/0,-1/0,-1/0]}function dt(t,r,e,n,i){return i?(i[0]=t,i[1]=r,i[2]=e,i[3]=n,i):[t,r,e,n]}function Xt(t){return dt(1/0,1/0,-1/0,-1/0,t)}function Nt(t,r){return r[0]<t[0]&&(t[0]=r[0]),r[2]>t[2]&&(t[2]=r[2]),r[1]<t[1]&&(t[1]=r[1]),r[3]>t[3]&&(t[3]=r[3]),t}function tt(t,r){r[0]<t[0]&&(t[0]=r[0]),r[0]>t[2]&&(t[2]=r[0]),r[1]<t[1]&&(t[1]=r[1]),r[1]>t[3]&&(t[3]=r[1])}function jt(t){var r=0;return Qt(t)||(r=P(t)*S(t)),r}function $t(t){return[t[0],t[1]]}function Bt(t){return[t[2],t[1]]}function Ht(t){return[(t[0]+t[2])/2,(t[1]+t[3])/2]}function S(t){return t[3]-t[1]}function Yt(t,r,e){var n=e||x();return _t(t,r)?(t[0]>r[0]?n[0]=t[0]:n[0]=r[0],t[1]>r[1]?n[1]=t[1]:n[1]=r[1],t[2]<r[2]?n[2]=t[2]:n[2]=r[2],t[3]<r[3]?n[3]=t[3]:n[3]=r[3]):Xt(n),n}function gt(t){return[t[0],t[3]]}function kt(t){return[t[2],t[3]]}function P(t){return t[2]-t[0]}function _t(t,r){return t[0]<=r[2]&&t[2]>=r[0]&&t[1]<=r[3]&&t[3]>=r[1]}function Qt(t){return t[2]<t[0]||t[3]<t[1]}function qt(t,r,e,n){var i=[];if(n>1)for(var a=t[2]-t[0],o=t[3]-t[1],s=0;s<n;++s)i.push(t[0]+a*s/n,t[1],t[2],t[1]+o*s/n,t[2]-a*s/n,t[3],t[0],t[3]-o*s/n);else i=[t[0],t[1],t[2],t[1],t[2],t[3],t[0],t[3]];r(i,i,2);for(var h=[],l=[],s=0,c=i.length;s<c;s+=2)h.push(i[s]),l.push(i[s+1]);return q(h,l,e)}var U={RADIANS:"radians",DEGREES:"degrees",FEET:"ft",METERS:"m",PIXELS:"pixels",TILE_PIXELS:"tile-pixels",USFEET:"us-ft"},M={};M[U.RADIANS]=6370997/(2*Math.PI),M[U.DEGREES]=2*Math.PI*6370997/360,M[U.FEET]=.3048,M[U.METERS]=1,M[U.USFEET]=1200/3937;var K=U,Kt=function(){function t(r){this.code_=r.code,this.units_=r.units,this.extent_=r.extent!==void 0?r.extent:null,this.worldExtent_=r.worldExtent!==void 0?r.worldExtent:null,this.axisOrientation_=r.axisOrientation!==void 0?r.axisOrientation:"enu",this.global_=r.global!==void 0?r.global:!1,this.canWrapX_=!!(this.global_&&this.extent_),this.getPointResolutionFunc_=r.getPointResolution,this.defaultTileGrid_=null,this.metersPerUnit_=r.metersPerUnit}return t.prototype.canWrapX=function(){return this.canWrapX_},t.prototype.getCode=function(){return this.code_},t.prototype.getExtent=function(){return this.extent_},t.prototype.getUnits=function(){return this.units_},t.prototype.getMetersPerUnit=function(){return this.metersPerUnit_||M[this.units_]},t.prototype.getWorldExtent=function(){return this.worldExtent_},t.prototype.getAxisOrientation=function(){return this.axisOrientation_},t.prototype.isGlobal=function(){return this.global_},t.prototype.setGlobal=function(r){this.global_=r,this.canWrapX_=!!(r&&this.extent_)},t.prototype.getDefaultTileGrid=function(){return this.defaultTileGrid_},t.prototype.setDefaultTileGrid=function(r){this.defaultTileGrid_=r},t.prototype.setExtent=function(r){this.extent_=r,this.canWrapX_=!!(this.global_&&r)},t.prototype.setWorldExtent=function(r){this.worldExtent_=r},t.prototype.setGetPointResolution=function(r){this.getPointResolutionFunc_=r},t.prototype.getPointResolutionFunc=function(){return this.getPointResolutionFunc_},t}(),Et=Kt,Vt=function(){var t;return"cosh"in Math?t=Math.cosh:t=function(r){var e=Math.exp(r);return(e+1/e)/2},t}(),bt=function(){var t;return"log2"in Math?t=Math.log2:t=function(r){return Math.log(r)*Math.LOG2E},t}();function Jt(t){for(var r=t.length,e=0;e<r;e++){for(var n=e,i=Math.abs(t[e][e]),a=e+1;a<r;a++){var o=Math.abs(t[a][e]);o>i&&(i=o,n=a)}if(i===0)return null;var s=t[n];t[n]=t[e],t[e]=s;for(var h=e+1;h<r;h++)for(var l=-t[h][e]/t[e][e],c=e;c<r+1;c++)e==c?t[h][c]=0:t[h][c]+=l*t[e][c]}for(var g=new Array(r),f=r-1;f>=0;f--){g[f]=t[f][r]/t[f][f];for(var d=f-1;d>=0;d--)t[d][r]-=t[d][f]*g[f]}return g}function nt(t){return t*Math.PI/180}function it(t,r){var e=t%r;return e*r<0?e+r:e}var Zt=function(){var t=function(r,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(n[a]=i[a])},t(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(r,e);function n(){this.constructor=r}r.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}}(),V=6378137,X=Math.PI*V,zt=[-X,-X,X,X],xt=[-180,-85,180,85],rt=V*Math.log(Math.tan(Math.PI/2)),N=function(t){Zt(r,t);function r(e){return t.call(this,{code:e,units:K.METERS,extent:zt,global:!0,worldExtent:xt,getPointResolution:function(n,i){return n/Vt(i[1]/V)}})||this}return r}(Et),pt=[new N("EPSG:3857"),new N("EPSG:102100"),new N("EPSG:102113"),new N("EPSG:900913"),new N("http://www.opengis.net/def/crs/EPSG/0/3857"),new N("http://www.opengis.net/gml/srs/epsg.xml#3857")];function tr(t,r,e){var n=t.length,i=e>1?e:2,a=r;a===void 0&&(i>2?a=t.slice():a=new Array(n));for(var o=0;o<n;o+=i){a[o]=X*t[o]/180;var s=V*Math.log(Math.tan(Math.PI*(+t[o+1]+90)/360));s>rt?s=rt:s<-rt&&(s=-rt),a[o+1]=s}return a}function rr(t,r,e){var n=t.length,i=e>1?e:2,a=r;a===void 0&&(i>2?a=t.slice():a=new Array(n));for(var o=0;o<n;o+=i)a[o]=180*t[o]/X,a[o+1]=360*Math.atan(Math.exp(t[o+1]/V))/Math.PI-90;return a}var er=function(){var t=function(r,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(n[a]=i[a])},t(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(r,e);function n(){this.constructor=r}r.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}}(),nr=6378137,mt=[-180,-90,180,90],ir=Math.PI*nr/180,G=function(t){er(r,t);function r(e,n){return t.call(this,{code:e,units:K.DEGREES,extent:mt,axisOrientation:n,global:!0,metersPerUnit:ir,worldExtent:mt})||this}return r}(Et),yt=[new G("CRS:84"),new G("EPSG:4326","neu"),new G("urn:ogc:def:crs:OGC:1.3:CRS84"),new G("urn:ogc:def:crs:OGC:2:84"),new G("http://www.opengis.net/def/crs/OGC/1.3/CRS84","neu"),new G("http://www.opengis.net/gml/srs/epsg.xml#4326","neu"),new G("http://www.opengis.net/def/crs/EPSG/0/4326","neu")],at={};function ar(t){return at[t]||at[t.replace(/urn:(x-)?ogc:def:crs:EPSG:(.*:)?(\w+)$/,"EPSG:$3")]||null}function or(t,r){at[t]=r}var Pt=typeof Object.assign=="function"?Object.assign:function(t,r){if(t==null)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),n=1,i=arguments.length;n<i;++n){var a=arguments[n];if(a!=null)for(var o in a)a.hasOwnProperty(o)&&(e[o]=a[o])}return e};function sr(t){for(var r in t)delete t[r]}var j={};function et(t,r,e){var n=t.getCode(),i=r.getCode();n in j||(j[n]={}),j[n][i]=e}function fr(t,r){var e;return t in j&&r in j[t]&&(e=j[t][r]),e}var ur=63710088e-1;function It(t,r,e){var n=e||ur,i=nt(t[1]),a=nt(r[1]),o=(a-i)/2,s=nt(r[0]-t[0])/2,h=Math.sin(o)*Math.sin(o)+Math.sin(s)*Math.sin(s)*Math.cos(i)*Math.cos(a);return 2*n*Math.atan2(Math.sqrt(h),Math.sqrt(1-h))}function Ot(t,r,e){var n;if(r!==void 0){for(var i=0,a=t.length;i<a;++i)r[i]=t[i];n=r}else n=t.slice();return n}function Tt(t,r,e){if(r!==void 0&&t!==r){for(var n=0,i=t.length;n<i;++n)r[n]=t[n];t=r}return t}function hr(t){or(t.getCode(),t),et(t,t,Ot)}function lr(t){t.forEach(hr)}function $(t){return typeof t=="string"?ar(t):t||null}function Mt(t,r,e,n){t=$(t);var i,a=t.getPointResolutionFunc();if(a){if(i=a(r,e),n&&n!==t.getUnits()){var o=t.getMetersPerUnit();o&&(i=i*o/M[n])}}else{var s=t.getUnits();if(s==K.DEGREES&&!n||n==K.DEGREES)i=r;else{var h=Rt(t,$("EPSG:4326"));if(h===Tt&&s!==K.DEGREES)i=r*t.getMetersPerUnit();else{var l=[e[0]-r/2,e[1],e[0]+r/2,e[1],e[0],e[1]-r/2,e[0],e[1]+r/2];l=h(l,l,2);var c=It(l.slice(0,2),l.slice(2,4)),g=It(l.slice(4,6),l.slice(6,8));i=(c+g)/2}var o=n?M[n]:t.getMetersPerUnit();o!==void 0&&(i/=o)}}return i}function wt(t){lr(t),t.forEach(function(r){t.forEach(function(e){r!==e&&et(r,e,Ot)})})}function vr(t,r,e,n){t.forEach(function(i){r.forEach(function(a){et(i,a,e),et(a,i,n)})})}function Rt(t,r){var e=t.getCode(),n=r.getCode(),i=fr(e,n);return i||(i=Tt),i}function ot(t,r){var e=$(t),n=$(r);return Rt(e,n)}function cr(t,r,e){var n=ot(r,e);return n(t,void 0,t.length)}function Dt(t,r,e,n){var i=ot(r,e);return qt(t,i,void 0,n)}function dr(){wt(pt),wt(yt),vr(yt,pt,tr,rr)}dr();var gr={imageSmoothingEnabled:!1,msImageSmoothingEnabled:!1},B=typeof navigator!="undefined"&&typeof navigator.userAgent!="undefined"?navigator.userAgent.toLowerCase():"";B.indexOf("firefox"),B.indexOf("safari")!==-1&&B.indexOf("chrom")==-1,B.indexOf("webkit")!==-1&&B.indexOf("edge")==-1,B.indexOf("macintosh");var _r=typeof WorkerGlobalScope!="undefined"&&typeof OffscreenCanvas!="undefined"&&self instanceof WorkerGlobalScope;(function(){var t=!1;try{var r=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("_",null,r),window.removeEventListener("_",null,r)}catch{}return t})();function Wt(t,r,e,n){var i;return e&&e.length?i=e.shift():_r?i=new OffscreenCanvas(t||300,r||300):(i=document.createElement("canvas"),i.style.all="unset"),t&&(i.width=t),r&&(i.height=r),i.getContext("2d",n)}var st;function Ct(t,r,e,n,i){t.beginPath(),t.moveTo(0,0),t.lineTo(r,e),t.lineTo(n,i),t.closePath(),t.save(),t.clip(),t.fillRect(0,0,Math.max(r,n)+1,Math.max(e,i)),t.restore()}function ft(t,r){return Math.abs(t[r*4]-210)>2||Math.abs(t[r*4+3]-.75*255)>2}function Er(){if(st===void 0){var t=document.createElement("canvas").getContext("2d");t.globalCompositeOperation="lighter",t.fillStyle="rgba(210, 0, 0, 0.75)",Ct(t,4,5,4,0),Ct(t,4,5,0,5);var r=t.getImageData(0,0,3,3).data;st=ft(r,0)||ft(r,4)||ft(r,8)}return st}function pr(t,r,e,n){var i=cr(e,r,t),a=Mt(r,n,e),o=r.getMetersPerUnit();o!==void 0&&(a*=o);var s=t.getMetersPerUnit();s!==void 0&&(a/=s);var h=t.getExtent();if(!h||St(h,i)){var l=Mt(t,a,i)/a;isFinite(l)&&l>0&&(a/=l)}return a}function mr(t,r,e,n,i,a,o,s,h,l,c,g){var f=Wt(Math.round(e*t),Math.round(e*r));if(Pt(f,g),h.length===0)return f.canvas;f.scale(e,e);function d(u){return Math.round(u*e)/e}f.globalCompositeOperation="lighter";var _=x();h.forEach(function(u,w,R){Nt(_,u.extent)});var b=P(_),J=S(_),p=Wt(Math.round(e*b/n),Math.round(e*J/n));Pt(p,g);var y=e/n;h.forEach(function(u,w,R){var E=u.extent[0]-_[0],m=-(u.extent[3]-_[3]),O=P(u.extent),I=S(u.extent);u.image.width>0&&u.image.height>0&&p.drawImage(u.image,l,l,u.image.width-2*l,u.image.height-2*l,E*y,m*y,O*y,I*y)});var v=gt(o);return s.getTriangles().forEach(function(u,w,R){var E=u.source,m=u.target,O=E[0][0],I=E[0][1],D=E[1][0],T=E[1][1],W=E[2][0],L=E[2][1],C=d((m[0][0]-v[0])/a),Z=d(-(m[0][1]-v[1])/a),Y=d((m[1][0]-v[0])/a),k=d(-(m[1][1]-v[1])/a),ht=d((m[2][0]-v[0])/a),lt=d(-(m[2][1]-v[1])/a),vt=O,ct=I;O=0,I=0,D-=vt,T-=ct,W-=vt,L-=ct;var Ar=[[D,T,0,0,Y-C],[W,L,0,0,ht-C],[0,0,D,T,k-Z],[0,0,W,L,lt-Z]],z=Jt(Ar);if(!!z){if(f.save(),f.beginPath(),Er()||g===gr){f.moveTo(Y,k);for(var Q=4,At=C-Y,Ft=Z-k,A=0;A<Q;A++)f.lineTo(Y+d((A+1)*At/Q),k+d(A*Ft/(Q-1))),A!=Q-1&&f.lineTo(Y+d((A+1)*At/Q),k+d((A+1)*Ft/(Q-1)));f.lineTo(ht,lt)}else f.moveTo(Y,k),f.lineTo(C,Z),f.lineTo(ht,lt);f.clip(),f.transform(z[0],z[2],z[1],z[3],C,Z),f.translate(_[0]-vt,_[3]-ct),f.scale(n/e,-n/e),f.drawImage(p.canvas,0,0),f.restore()}}),c&&(f.save(),f.globalCompositeOperation="source-over",f.strokeStyle="black",f.lineWidth=1,s.getTriangles().forEach(function(u,w,R){var E=u.target,m=(E[0][0]-v[0])/a,O=-(E[0][1]-v[1])/a,I=(E[1][0]-v[0])/a,D=-(E[1][1]-v[1])/a,T=(E[2][0]-v[0])/a,W=-(E[2][1]-v[1])/a;f.beginPath(),f.moveTo(I,D),f.lineTo(m,O),f.lineTo(T,W),f.closePath(),f.stroke()}),f.restore()),f.canvas}var yr=.5,Pr=10,Gt=.25,Ir=function(){function t(r,e,n,i,a,o){this.sourceProj_=r,this.targetProj_=e;var s={},h=ot(this.targetProj_,this.sourceProj_);this.transformInv_=function(v){var u=v[0]+"/"+v[1];return s[u]||(s[u]=h(v)),s[u]},this.maxSourceExtent_=i,this.errorThresholdSquared_=a*a,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!i&&!!this.sourceProj_.getExtent()&&P(i)==P(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?P(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?P(this.targetProj_.getExtent()):null;var l=gt(n),c=kt(n),g=Bt(n),f=$t(n),d=this.transformInv_(l),_=this.transformInv_(c),b=this.transformInv_(g),J=this.transformInv_(f),p=Pr+(o?Math.max(0,Math.ceil(bt(jt(n)/(o*o*256*256)))):0);if(this.addQuad_(l,c,g,f,d,_,b,J,p),this.wrapsXInSource_){var y=1/0;this.triangles_.forEach(function(v,u,w){y=Math.min(y,v.source[0][0],v.source[1][0],v.source[2][0])}),this.triangles_.forEach(function(v){if(Math.max(v.source[0][0],v.source[1][0],v.source[2][0])-y>this.sourceWorldWidth_/2){var u=[[v.source[0][0],v.source[0][1]],[v.source[1][0],v.source[1][1]],[v.source[2][0],v.source[2][1]]];u[0][0]-y>this.sourceWorldWidth_/2&&(u[0][0]-=this.sourceWorldWidth_),u[1][0]-y>this.sourceWorldWidth_/2&&(u[1][0]-=this.sourceWorldWidth_),u[2][0]-y>this.sourceWorldWidth_/2&&(u[2][0]-=this.sourceWorldWidth_);var w=Math.min(u[0][0],u[1][0],u[2][0]),R=Math.max(u[0][0],u[1][0],u[2][0]);R-w<this.sourceWorldWidth_/2&&(v.source=u)}}.bind(this))}s={}}return t.prototype.addTriangle_=function(r,e,n,i,a,o){this.triangles_.push({source:[i,a,o],target:[r,e,n]})},t.prototype.addQuad_=function(r,e,n,i,a,o,s,h,l){var c=F([a,o,s,h]),g=this.sourceWorldWidth_?P(c)/this.sourceWorldWidth_:null,f=this.sourceWorldWidth_,d=this.sourceProj_.canWrapX()&&g>.5&&g<1,_=!1;if(l>0){if(this.targetProj_.isGlobal()&&this.targetWorldWidth_){var b=F([r,e,n,i]),J=P(b)/this.targetWorldWidth_;_=J>Gt||_}!d&&this.sourceProj_.isGlobal()&&g&&(_=g>Gt||_)}if(!(!_&&this.maxSourceExtent_&&isFinite(c[0])&&isFinite(c[1])&&isFinite(c[2])&&isFinite(c[3])&&!_t(c,this.maxSourceExtent_))){var p=0;if(!_&&(!isFinite(a[0])||!isFinite(a[1])||!isFinite(o[0])||!isFinite(o[1])||!isFinite(s[0])||!isFinite(s[1])||!isFinite(h[0])||!isFinite(h[1]))){if(l>0)_=!0;else if(p=(!isFinite(a[0])||!isFinite(a[1])?8:0)+(!isFinite(o[0])||!isFinite(o[1])?4:0)+(!isFinite(s[0])||!isFinite(s[1])?2:0)+(!isFinite(h[0])||!isFinite(h[1])?1:0),p!=1&&p!=2&&p!=4&&p!=8)return}if(l>0){if(!_){var y=[(r[0]+n[0])/2,(r[1]+n[1])/2],v=this.transformInv_(y),u=void 0;if(d){var w=(it(a[0],f)+it(s[0],f))/2;u=w-it(v[0],f)}else u=(a[0]+s[0])/2-v[0];var R=(a[1]+s[1])/2-v[1],E=u*u+R*R;_=E>this.errorThresholdSquared_}if(_){if(Math.abs(r[0]-n[0])<=Math.abs(r[1]-n[1])){var m=[(e[0]+n[0])/2,(e[1]+n[1])/2],O=this.transformInv_(m),I=[(i[0]+r[0])/2,(i[1]+r[1])/2],D=this.transformInv_(I);this.addQuad_(r,e,m,I,a,o,O,D,l-1),this.addQuad_(I,m,n,i,D,O,s,h,l-1)}else{var T=[(r[0]+e[0])/2,(r[1]+e[1])/2],W=this.transformInv_(T),L=[(n[0]+i[0])/2,(n[1]+i[1])/2],C=this.transformInv_(L);this.addQuad_(r,T,L,i,a,W,C,h,l-1),this.addQuad_(T,e,n,L,W,o,s,C,l-1)}return}}if(d){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}(p&11)==0&&this.addTriangle_(r,n,i,a,s,h),(p&14)==0&&this.addTriangle_(r,n,e,a,s,o),p&&((p&13)==0&&this.addTriangle_(e,i,r,o,h,a),(p&7)==0&&this.addTriangle_(e,i,n,o,h,s))}},t.prototype.calculateSourceExtent=function(){var r=x();return this.triangles_.forEach(function(e,n,i){var a=e.source;tt(r,a[0]),tt(r,a[1]),tt(r,a[2])}),r},t.prototype.getTriangles=function(){return this.triangles_},t}(),Or=Ir,Tr=function(){function t(){this.disposed=!1}return t.prototype.dispose=function(){this.disposed||(this.disposed=!0,this.disposeInternal())},t.prototype.disposeInternal=function(){},t}(),Mr=Tr,wr=function(){function t(r){this.propagationStopped,this.defaultPrevented,this.type=r,this.target=null}return t.prototype.preventDefault=function(){this.defaultPrevented=!0},t.prototype.stopPropagation=function(){this.propagationStopped=!0},t}(),Rr=wr;function Lt(){}var Dr=function(){var t=function(r,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(n[a]=i[a])},t(r,e)};return function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(r,e);function n(){this.constructor=r}r.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}}(),Wr=function(t){Dr(r,t);function r(e){var n=t.call(this)||this;return n.eventTarget_=e,n.pendingRemovals_=null,n.dispatching_=null,n.listeners_=null,n}return r.prototype.addEventListener=function(e,n){if(!(!e||!n)){var i=this.listeners_||(this.listeners_={}),a=i[e]||(i[e]=[]);a.indexOf(n)===-1&&a.push(n)}},r.prototype.dispatchEvent=function(e){var n=typeof e=="string"?new Rr(e):e,i=n.type;n.target||(n.target=this.eventTarget_||this);var a=this.listeners_&&this.listeners_[i],o;if(a){var s=this.dispatching_||(this.dispatching_={}),h=this.pendingRemovals_||(this.pendingRemovals_={});i in s||(s[i]=0,h[i]=0),++s[i];for(var l=0,c=a.length;l<c;++l)if("handleEvent"in a[l]?o=a[l].handleEvent(n):o=a[l].call(this,n),o===!1||n.propagationStopped){o=!1;break}if(--s[i],s[i]===0){var g=h[i];for(delete h[i];g--;)this.removeEventListener(i,Lt);delete s[i]}return o}},r.prototype.disposeInternal=function(){this.listeners_&&sr(this.listeners_)},r.prototype.getListeners=function(e){return this.listeners_&&this.listeners_[e]||void 0},r.prototype.hasListener=function(e){return this.listeners_?e?e in this.listeners_:Object.keys(this.listeners_).length>0:!1},r.prototype.removeEventListener=function(e,n){var i=this.listeners_&&this.listeners_[e];if(i){var a=i.indexOf(n);a!==-1&&(this.pendingRemovals_&&e in this.pendingRemovals_?(i[a]=Lt,++this.pendingRemovals_[e]):(i.splice(a,1),i.length===0&&delete this.listeners_[e]))}},r}(Mr),Cr=Wr,Gr={CHANGE:"change",ERROR:"error",BLUR:"blur",CLEAR:"clear",CONTEXTMENU:"contextmenu",CLICK:"click",DBLCLICK:"dblclick",DRAGENTER:"dragenter",DRAGOVER:"dragover",DROP:"drop",FOCUS:"focus",KEYDOWN:"keydown",KEYPRESS:"keypress",LOAD:"load",RESIZE:"resize",TOUCHMOVE:"touchmove",WHEEL:"wheel"},ut;(function(t){t[t.IDLE=0]="IDLE",t[t.LOADING=1]="LOADING",t[t.LOADED=2]="LOADED",t[t.ERROR=3]="ERROR",t[t.EMPTY=4]="EMPTY"})(ut||(ut={}));var H=ut;class Lr extends Cr{constructor(r){super();this.type="canvas",this._options=r,this._projection=$(r.projection),this._imageExtent=r.imageExtent,this._imageState=H.IDLE,this._initCoordinates(),this._loadImage()}_initCoordinates(){const{projection:r,imageExtent:e}=this._options,n=Dt(e,r,"EPSG:4326");this.coordinates=[[n[0],n[3]],[n[2],n[3]],[n[2],n[1]],[n[0],n[1]]]}_loadImage(){const{crossOrigin:r,url:e}=this._options,n=new Image;r&&(n.crossOrigin=r),n.src=e,n.src&&typeof Image!="undefined"&&Image.prototype.decode&&n.decode().then(()=>this._handleImageLoad()).catch(a=>{console.error(a),this._handleImageError()}),this._imageState=H.LOADING,this._image=n}_handleImageLoad(){this.getResolution()===void 0&&(this._resolution=S(this._options.imageExtent)/this._image.height),this._imageState=H.LOADED,this._handleImageChange()}_handleImageError(){this._imageState=H.ERROR}_handleImageChange(){this.getImageState()==H.LOADED&&this._reprojectImage()}_reprojectImage(){const r=this.getProjection(),e=$("EPSG:3857"),n=Dt(this._imageExtent,r,e),i=P(n)/this._image.width,a=S(n)/this._image.height,o=Math.max(i,a);this._reproject(r,e,n,o)}_reproject(r,e,n,i){if(this.getImageState()==H.LOADED){const a=r.getExtent(),o=e.getExtent(),s=P(n)/i,h=S(n)/i,l=1,c=o?Yt(n,o):n,g=Ht(c),f=pr(r,e,g,i),d=new Or(r,e,c,a,f*yr,i);this.canvas=mr(s,h,l,this.getResolution(),a,i,n,d,[{extent:this._options.imageExtent,image:this._image}],0),this.dispatchEvent(Gr.LOAD)}}getProjection(){return this._projection}getImageState(){return this._imageState}getResolution(){return this._resolution}}return Lr});
